name: Daily Content Release (from private staging)

on:
  schedule:
    - cron: '0 9 * * *'  # 09:00 UTC daily
  workflow_dispatch:
    inputs:
      overrideDay:
        description: 'Release a specific day number (e.g. 7)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PUBLIC repo
        uses: actions/checkout@v4

      - name: Checkout PRIVATE staging repo
        uses: actions/checkout@v4
        with:
          repository: razaqfatiu/30days-staging     # <-- your private repo
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}  # PAT with repo:read
          path: staging

      - name: Determine next day
        id: next
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ github.event.inputs.overrideDay }}" ]; then
            DAY="${{ github.event.inputs.overrideDay }}"
          elif [ -f ".release_state.json" ]; then
            DAY=$(jq -r '.next' .release_state.json)
          else
            DAY=2
          fi
          printf -v DAY_PAD "%02d" "$DAY"
          CANDIDATE=$(ls -d staging/scheduled/day${DAY_PAD}_* 2>/dev/null | head -n1 || true)
          echo "day=${DAY}" >> $GITHUB_OUTPUT
          echo "day_pad=${DAY_PAD}" >> $GITHUB_OUTPUT
          echo "candidate=${CANDIDATE}" >> $GITHUB_OUTPUT

      - name: Stop if nothing to release
        if: steps.next.outputs.candidate == ''
        run: echo "No scheduled content available for day ${{ steps.next.outputs.day }}"

      - name: Publish day folder
        if: steps.next.outputs.candidate != ''
        id: publish
        shell: bash
        run: |
          set -euo pipefail
          SRC="${{ steps.next.outputs.candidate }}"
          BASENAME=$(basename "$SRC")
          cp -r "$SRC" "./$BASENAME"
          echo "basename=$BASENAME" >> $GITHUB_OUTPUT

          # bump pointer only if not overriding
          if [ -z "${{ github.event.inputs.overrideDay }}" ]; then
            NEXT=$(( ${{ steps.next.outputs.day }} + 1 ))
            jq -n --argjson n "$NEXT" '{next: $n}' > .release_state.json
            git add .release_state.json
          fi

          git add "$BASENAME"

      - name: Merge package.json from staging
        if: steps.next.outputs.candidate != ''
        id: mergepkg
        shell: bash
        run: |
          set -euo pipefail
          # Paths
          PUB_PKG="package.json"
          STG_PKG="staging/package.json"
          BASENAME="${{ steps.publish.outputs.basename }}"
          DAY="${{ steps.next.outputs.day }}"

          # Ensure a public package.json exists
          if [ ! -f "$PUB_PKG" ]; then
            echo '{}' > "$PUB_PKG"
          fi

          # Load JSON (fall back to {} if staging file missing)
          if [ -f "$STG_PKG" ]; then
            STAGING_JSON=$(cat "$STG_PKG")
          else
            STAGING_JSON='{}'
          fi

          # Build dynamic scripts for this day
          VANILLA_SCRIPT="npx tsx ${BASENAME}/code.ts"
          FRAMEWORK_SCRIPT="npx tsx ${BASENAME}/framework.ts"
          DAY_VARNAME="dev:day${DAY}:vanilla"
          DAY_FWKNAME="dev:day${DAY}:framework"

          # jq merge:
          # - Create scripts object if missing
          # - Merge deps/devDeps (staging overrides versions if same key)
          # - Add the two day-specific scripts
          # - Ensure tsx is present in devDependencies
          jq \
            --argjson STG "$STAGING_JSON" \
            --arg VAN "$VANILLA_SCRIPT" \
            --arg FWK "$FRAMEWORK_SCRIPT" \
            --arg DSV "$DAY_VARNAME" \
            --arg DSF "$DAY_FWKNAME" \
            '
            . as $pub
            | ($pub.scripts // {}) as $ps
            | ($pub.dependencies // {}) as $pd
            | ($pub.devDependencies // {}) as $pdd
            | ($STG.dependencies // {}) as $sd
            | ($STG.devDependencies // {}) as $sdd
            | ($STG.scripts // {}) as $ss
            | {
                # Keep existing, merge in staging
                dependencies: ($pd + $sd),
                devDependencies: ($pdd + $sdd),
                scripts: ($ps + $ss)
              }
            | $pub + .
            | .scripts[$DSV] = $VAN
            | .scripts[$DSF] = $FWK
            | .devDependencies.tsx = (.devDependencies.tsx // "^4.7.0")
            ' "$PUB_PKG" > package.merged.json

          mv package.merged.json package.json
          git add package.json

      - name: Commit and push
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Auto release: ${{ steps.publish.outputs.basename }} + package.json updates" || echo "No changes to commit"
          git push

      - name: Optional update README index
        if: steps.next.outputs.candidate != ''
        shell: bash
        run: |
          BASENAME="${{ steps.publish.outputs.basename }}"
          if ! grep -q "${BASENAME}" README.md 2>/dev/null; then
            echo "" >> README.md
            echo "- [${BASENAME}](./${BASENAME})" >> README.md
            git add README.md
            git commit -m "Index ${BASENAME} in README" || true
            git push || true
          fi
